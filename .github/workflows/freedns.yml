name: Update Fraidex Data

on:
  schedule:
    - cron: "0 * * * *" # Runs every hour.
  workflow_dispatch: # Allows manual triggering from the Actions tab
  push:
    branches:
      - main
    paths:
      - "parser.py"

permissions:
  contents: write # Required to push to the results branch

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Fetch previous fraidex.json from results branch
        run: |
          git fetch origin results || true
          git show origin/results:fraidex.json > fraidex_previous.json 2>/dev/null \
            && echo "Loaded previous fraidex data — first_seen dates will be preserved." \
            || echo "No previous results found — all domains will be marked as new today."

      - name: Generate fraidex.json
        run: |
          echo "Running parser.py..."
          python parser.py
          if [ ! -f "fraidex.json" ]; then
            echo "Error: fraidex.json was not created!"
            exit 1
          fi
          echo "fraidex.json created successfully."

      - name: Publish to results branch
        run: |
          # 1. Move the generated file to a safe location outside the git tree
          mkdir -p ../temp_storage
          mv fraidex.json ../temp_storage/

          # 2. Configure Git identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 3. Switch to the existing results branch (or create it as orphan on first run)
          git fetch origin results || true
          if git ls-remote --exit-code --heads origin results > /dev/null 2>&1; then
            git checkout results
          else
            git checkout --orphan results
            git rm -rf . --quiet || true
          fi

          # 4. Remove everything except .git so only fraidex.json remains
          find . -maxdepth 1 -not -name '.git' -not -name '.' | xargs rm -rf

          # 5. Bring back the generated data file
          mv ../temp_storage/fraidex.json .

          # 6. Stage and commit (skip if nothing changed)
          git add fraidex.json
          git diff --staged --quiet && echo "No changes to commit." || git commit -m "Update data: $(date -u)"

          # 7. Push to the remote results branch
          git push origin results
